<% if (@profile.user == current_user && @profile.user.can_receive_payments?) || current_user.admin == true %>

  <!-- DASHBOARD - ORGANIZER -->

  <% content_for :meta_title, "Jeu de Mains | Tableau de Bord" %>


  <div class="dashboard-title-container" id="dashboard-organizer-title-container">
    <h1>
      Hello <span><%= @profile.company %></span>,<br>bienvenue sur votre tableau de bord !
    </h1>
  </div>
  <div class="dashboard-organizer-container">
    <div class="dashboard-nav-and-tab" id="dashboard-organizer-nav-and-tab">

      <!-- NAV PILLS DESKTOP & TABLET -->

      <div class="dashboard-nav-desktop-tablet">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <a class="nav-link active" id="v-pills-my-workshops-tab" data-toggle="pill" href="#v-pills-my-workshops" role="tab" aria-controls="v-pills-my-workshops" aria-selected="true">
            Mes ateliers
          </a>
          <a class="nav-link" id="v-pills-my-agenda-to-come-tab" data-toggle="pill" href="#v-pills-my-agenda-to-come" role="tab" aria-controls="v-pills-my-agenda-to-come" aria-selected="false">
            Mon planning à venir
          </a>
          <a class="nav-link" id="v-pills-my-agenda-passed-tab" data-toggle="pill" href="#v-pills-my-agenda-passed" role="tab" aria-controls="v-pills-my-agenda-passed" aria-selected="false">
            Mon planning passé
          </a>
          <a class="nav-link" id="v-pills-kits-sending-tab" data-toggle="pill" href="#v-pills-kits-sending" role="tab" aria-controls="v-pills-kits-sending" aria-selected="false">
            Mes envois de kits
          </a>
          <a class="nav-link" id="v-pills-my-reviews-tab" data-toggle="pill" href="#v-pills-my-reviews" role="tab" aria-controls="v-pills-my-reviews" aria-selected="false">
            Mes avis
          </a>
          <a class="nav-link" id="v-pills-my-kpis-tab" data-toggle="pill" href="#v-pills-my-kpis" role="tab" aria-controls="v-pills-my-kpis" aria-selected="false">
            Mes chiffres clés
          </a>
          <a class="nav-link" id="v-pills-my-transactions-tab" data-toggle="pill" href="#v-pills-my-transactions" role="tab" aria-controls="v-pills-my-transactions" aria-selected="false">
            Mes transactions
          </a>
        </div>
      </div>

      <!-- NAV PILLS MOBILE -->

      <div class="dashboard-nav-mobile">
        <div class="nav nav-pills nav-pills-organizer" id="pills-tab" role="tablist">
          <a class="nav-link active" id="v-pills-my-workshops-tab" data-toggle="pill" href="#v-pills-my-workshops" role="tab" aria-controls="v-pills-my-workshops" aria-selected="true">
            <span>Mes ateliers</span>
          </a>
          <a class="nav-link" id="v-pills-my-agenda-to-come-tab" data-toggle="pill" href="#v-pills-my-agenda-to-come" role="tab" aria-controls="v-pills-my-agenda-to-come" aria-selected="false">
            <span>Mon planning à venir</span>
          </a>
          <a class="nav-link" id="v-pills-my-agenda-passed-tab" data-toggle="pill" href="#v-pills-my-agenda-passed" role="tab" aria-controls="v-pills-my-agenda-passed" aria-selected="false">
            <span>Mon planning passé</span>
          </a>
          <a class="nav-link" id="v-pills-kits-sending-tab" data-toggle="pill" href="#v-pills-kits-sending" role="tab" aria-controls="v-pills-kits-sending" aria-selected="false">
            <span>Mes envois de kits</span>
          </a>
          <a class="nav-link" id="v-pills-my-reviews-tab" data-toggle="pill" href="#v-pills-my-reviews" role="tab" aria-controls="v-pills-my-reviews" aria-selected="false">
            <span>Mes avis</span>
          </a>
          <a class="nav-link" id="v-pills-my-kpis-tab" data-toggle="pill" href="#v-pills-my-kpis" role="tab" aria-controls="v-pills-my-kpis" aria-selected="false">
            <span>Mes chiffres clés</span>
          </a>
          <a class="nav-link" id="v-pills-my-transactions-tab" data-toggle="pill" href="#v-pills-my-transactions" role="tab" aria-controls="v-pills-my-transactions" aria-selected="false">
            <span>Mes transactions</span>
          </a>
        </div>
      </div>

      <!-- NAV TABS -->

      <div class="dashboard-tabs" id="dashboard-organizer-tabs">
        <div class="tab-content" id="pills-tabContent">
          <% my_workshops = [] %>
          <% my_workshops_online = [] %>
          <% my_workshops_in_validation = [] %>
          <% my_workshops_offline = [] %>
          <% my_sessions = [] %>
          <% canceled_bookings = [] %>
          <% my_dates = [] %>

          <!-- ORGANISÉS -->
          <% @profile.user.places.where(db_status: true).each do |place| %>
            <% if place.workshops.where(db_status: true) %>
              <% place.workshops.where(db_status: true).each do |workshop| %>
                <% my_workshops << workshop %>
                <% if workshop.status == "en ligne" && workshop.verified == true %>
                  <% my_workshops_online << workshop %>
                <% elsif workshop.status == "vérification" %>
                  <% my_workshops_in_validation << workshop %>
                <% else %>
                  <% my_workshops_offline << workshop %>
                <% end %>
                <% workshop.sessions.where(db_status: true).each do |session| %>
                  <% my_sessions << session %>
                  <% my_dates << session.date if session.workshop.verified == true %>
                <% end %>
                <% workshop.sessions.each do |session| %>
                  <% session.bookings.where(db_status: true, status: "refunded").each do |booking| %>
                    <% canceled_bookings << booking %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>

          <!-- ANIMÉS -->
          <% @profile.user.animators.where(db_status: true).each do |animator| %>
            <% if animator.workshop.db_status == true && animator.workshop.animators.where(db_status: true).last.user == @profile.user %>
              <% my_workshops << animator.workshop %>
                <% if animator.workshop.status == "en ligne" && animator.workshop.verified == true %>
                  <% my_workshops_online << animator.workshop %>
                <% elsif animator.workshop.status == "vérification" %>
                  <% my_workshops_in_validation << animator.workshop %>
                <% else %>
                  <% my_workshops_offline << animator.workshop %>
                <% end %>
              <% animator.workshop.sessions.where(db_status: true).each do |session| %>
                <% my_sessions << session %>
                <% my_dates << session.date if session.workshop.verified == true %>
              <% end %>
              <% animator.workshop.sessions.each do |session| %>
                <% session.bookings.where(db_status: false, status: "refunded").each do |booking| %>
                  <% canceled_bookings << booking %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>

          <% my_workshops_online = my_workshops_online.sort_by { |workshop| workshop.created_at } %>
          <% my_workshops_in_validation = my_workshops_in_validation.sort_by { |workshop| workshop.created_at } %>
          <% my_workshops_offline = my_workshops_offline.sort_by { |workshop| workshop.created_at } %>
          <% my_workshops_online_then_offline = my_workshops_online.concat(my_workshops_in_validation).concat(my_workshops_offline) %>

          <!-- MY WORKSHOPS -->

          <div class="tab-pane fade show active" id="v-pills-my-workshops" role="tabpanel" aria-labelledby="v-pills-my-workshops-tab">

            <%= link_to new_workshop_path, id: "add-new-workshop" do %>
              <i class="fas fa-plus mr-1"></i>
              <span>Créer un atelier</span>
            <% end %>
            <% my_workshops_online_then_offline.each_with_index do |workshop, index| %>

              <% my_ws_bookings_7_days = [] %>
              <% my_ws_bookings_today = [] %>
              <% all_my_ws_bookings = [] %>
              <% workshop.sessions.where(db_status: true).each do |session| %>
                <% if session.date >= (Date.today - 7) && session.date < Date.today %>
                  <% session.bookings.where(db_status: true, status: 'paid').each {|b| my_ws_bookings_7_days << b } %>
                <% end %>
                <% if session.date >= Date.today %>
                  <% session.bookings.where(db_status: true, status: 'paid').each {|b| my_ws_bookings_today << b } %>
                <% end %>
                <% session.bookings.where(db_status: true, status: 'paid').each {|b| all_my_ws_bookings << b } %>
              <% end %>

              <% if workshop.status == "en ligne" %>
                <div class="ws-dashboard-organizer-card-container">
              <% elsif workshop.status == "vérification" %>
                <div class="ws-dashboard-organizer-card-container" id="in-validation-ws">
              <% else %>
                <div class="ws-dashboard-organizer-card-container" id="offline-ws">
              <% end %>
                <div class="ws-dashboard-organizer-card">
                  <div class="ws-dashboard-organizer-image">
                    <% if workshop.photos.attached? %>
                      <%= cl_image_tag workshop.photos[0].key, loading: "lazy", alt: "jeu-de-mains-#{workshop.title}", title: "jeu-de-mains-#{workshop.title}", width: 95, height: 95, crop: :fill %>
                    <% else %>
                      <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593177818/jeu-de-mains-atelier.jpg", :loading => "lazy", :width => 95, :height => 95, :crop => :fill, :alt => "jeu-de-mains-#{workshop.title}", :title => "jeu-de-mains-#{workshop.title}") %>
                    <% end %>
                  </div>
                  <span id="dashboard-workshop-status"><%= workshop.status.capitalize %></span>
                  <div class="ws-dashboard-organizer-text-and-buttons">
                    <div class="ws-dashboard-organizer-text">
                      <%= link_to workshop_path(workshop) do %>
                        <% if workshop.place.name.include?("Atelier en visio") %>
                          <h2><span class="ws-dashboard-organizer-visio">VISIO</span> <%= workshop.title %></h2>
                        <% else %>
                          <h2><%= workshop.title %></h2>
                        <% end %>
                      <% end %>
                      <span class="ws-dashboard-organizer-text-your-role">
                        <% if workshop.place.user == @profile.user %>
                          <i class="fas fa-user-shield mr-1"></i> Organisé par vous
                        <% else %>
                          <i class="fas fa-palette mr-1"></i>Animé par vous
                        <% end %>
                      </span>

                      <% if workshop.place.user == @profile.user && workshop.animators.where(db_status: true).present? %>
                        <h3>Animé par
                          <%= link_to profile_public_path(workshop.animators.where(db_status: true).last.user.profile) do %>
                            <%= workshop.animators.where(db_status: true).last.user.profile.company %>
                          <% end %>
                        </h3>
                      <% elsif workshop.place.user != @profile.user %>
                        <h3>Organisé par <%= workshop.place.user.profile.company %></h3>
                      <% end %>
                      <% if workshop.visio == true %>
                        <h3>En visioconférence</h3>
                      <% else %>
                        <h3>Chez <%= workshop.place.name[0..28] %> à <%= workshop.place.city.capitalize %></h3>
                      <% end %>
                    </div>
                    <div class="show-actions-button show-actions-button-<%= index +1 %> active" id="showActionsButtons-<%= index +1 %>">
                      <%= link_to "#", class: "button" do %>
                        Gérer
                        <i class="fas fa-angle-right ml-2"></i>
                      <% end %>
                    </div>


                    <div class="ws-dashboard-organizer-buttons" id="ws-dashboard-organizer-buttons-<%= index +1 %>">

                      <% if workshop.place.user == @profile.user %>
                        <div>
                          <a href="#addSessionModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo" id="add-date-button">
                            <i class="fas fa-plus mr-1"></i>
                            <span>Ajouter une date</span>
                          </a>

                          <div class="modal fade add-session-modal" id="addSessionModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="addSessionModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">

                                <div class="form-group">
                                  <%= simple_form_for([workshop, @session]) do |f| %>
                                    <div class="modal-body">
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                      </button>

                                      <%= f.input :date, required: true, label: "Date de l'atelier" %>
                                      <%= f.input :start_at, required: true, label: "Heure de début", collection: Session::STARTS_AT %>
                                      <%= f.input :capacity, label: "Nombre de places si différent de celui indiqué dans la fiche atelier" %>

                                      <div class="d-flex justify-content-center">
                                        <%= f.submit 'Valider', class: "new-edit-ws-submit" %>
                                      </div>

                                    </div>
                                  <% end %>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% end %>

                      <% if workshop.place.user == @profile.user %>

                        <% if workshop.animators.where(db_status: true).count == 0 %>

                          <div>
                            <a href="#addAnimatorModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo" id="add-animator-button">
                              <i class="fas fa-plus mr-1"></i>
                              <span>Ajouter un animateur</span>
                            </a>

                            <div class="modal fade add-animator-modal" id="addAnimatorModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="addAnimatorModalLabel" aria-hidden="true">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">

                                  <div class="form-group">
                                    <%= simple_form_for([workshop, @animator]) do |f| %>
                                      <div class="modal-body">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                        </button>

                                        <div class="form-group select required animator_user">
                                          <label class="select required" for="animator_user_id">
                                            Vous vous apprêtez à attribuer un animateur à votre atelier. L'animateur doit avoir été mis au courant au préalable de votre collaboration. Jeu de Mains n'est pas responsable des collaborations entre organisateurs et animateurs d'ateliers.
                                          </label>
                                          <select class="form-control select required" name="animator[user_id]" id="animator_user_id">
                                              <option value=""></option>
                                            <% @users.sort_by { |user| user.profile.company }.each do |user| %>
                                              <option value="<%= user.id %>"><%= user.profile.company %></option>
                                            <% end %>
                                          </select>
                                        </div>

                                        <div class="d-flex justify-content-center">
                                          <%= f.submit 'Valider', class: "new-edit-ws-submit" %>
                                        </div>
                                      </div>
                                    <% end %>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                        <% elsif workshop.animators.where(db_status: true).present? && all_my_ws_bookings.empty? %>
                          <div>
                            <a href="#updateAnimatorModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo">
                              <span>Remplacer l'animateur</span>
                            </a>

                            <div class="modal fade add-animator-modal" id="updateAnimatorModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="updateAnimatorModalLabel" aria-hidden="true">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">

                                  <div class="form-group">
                                    <%= form_for workshop.animators.where(db_status: true).last, method: :patch do |f| %>
                                      <div class="modal-body">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                        </button>

                                        <div class="form-group select required animator_user">
                                          <label class="select required" for="animator_user_id">Animateur</label>
                                          <select class="form-control select required" name="animator[user_id]" id="animator_user_id">
                                            <option value="<%= workshop.animators.where(db_status: true).last.user.id %>" selected><%= workshop.animators.where(db_status: true).last.user.profile.company %></option>
                                            <option value="">----------------</option>
                                            <% @users.sort_by { |user| user.profile.company }.each do |user| %>
                                              <option value="<%= user.id %>"><%= user.profile.company %></option>
                                            <% end %>
                                          </select>
                                        </div>

                                        <div class="d-flex justify-content-center">
                                          <%= f.submit 'Valider', class: "new-edit-ws-submit" %>
                                        </div>
                                      </div>
                                    <% end %>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                        <% else %>
                          <a href="#disabledAnimatorModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo" id="turn-online-offline-button-disabled">
                              Remplacer l'animateur
                            </a>

                          <div class="modal fade disabled-modal" id="disabledAnimatorModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="disabledAnimatorModalLabel" aria-hidden="true">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                  <div class="form-group">
                                    <div class="modal-body">
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                      </button>
                                      <div class="mt-3">
                                        Vous avez déjà eu des réservations pour cet atelier, vous ne pouvez pas modifier l'animateur.<br>
                                        Si vous souhaitez attribuer un autre animateur, alors vous devez créer un nouvel atelier, par exemple en dupliquant celui-ci &#128521;
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                        <% end %>
                      <% end %>

                      <% if workshop.place.user == @profile.user %>
                        <%= link_to "Modifier la fiche", edit_workshop_path(workshop), class: "button mr-2" %>
                      <% end %>
                      <% if workshop.place.user == @profile.user %>
                        <%= link_to "Gérer les sessions", workshop_sessions_path(workshop), class: "button mr-2" %>
                      <% else %>
                        <%= link_to "Voir les sessions", workshop_sessions_path(workshop), class: "button mr-2" %>
                      <% end %>

                      <% if workshop.place.user == @profile.user %>

                        <%= simple_form_for(@workshop) do |f| %>
                          <%= f.hidden_field :title, value: workshop.title %>
                          <%= f.hidden_field :program, value: workshop.program %>
                          <%= f.hidden_field :final_product, value: workshop.final_product %>
                          <%= f.hidden_field :thematic, value: workshop.thematic %>
                          <%= f.hidden_field :level, value: workshop.level %>
                          <%= f.hidden_field :duration, value: workshop.duration %>
                          <%= f.hidden_field :price, value: workshop.price %>
                          <%= f.hidden_field :capacity, value: workshop.capacity %>
                          <%= f.hidden_field :kit, value: workshop.kit %>
                          <%= f.hidden_field :kit_description, value: workshop.kit_description %>
                          <%= f.hidden_field :ephemeral, value: workshop.ephemeral %>
                          <%= f.hidden_field :place_id, value: workshop.place_id %>
                          <%= f.hidden_field :visio, value: workshop.visio %>
                          <%= f.submit 'Dupliquer', class: "button mr-2", id: "turn-online-offline-button" %>
                        <% end %>
                      <% end %>


                      <% if workshop.place.user == @profile.user %>

                        <% if workshop.status == "en ligne" && my_ws_bookings_today.empty? %>
                          <%= form_for workshop, method: :patch do |f| %>
                            <%= f.hidden_field :status, value: 'hors ligne' %>
                            <%= f.hidden_field :verified, value: false %>
                            <%= f.submit 'Passer hors ligne', class: "button mr-2", id: "turn-online-offline-button" %>
                          <% end %>
                        <% elsif workshop.status == "en ligne" && my_ws_bookings_today.size > 0 %>
                          <a href="#disabledModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo" id="turn-online-offline-button-disabled">
                              Passer hors ligne
                            </a>

                          <div class="modal fade disabled-modal" id="disabledModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="disabledModalLabel" aria-hidden="true">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                  <div class="form-group">
                                    <div class="modal-body">
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                      </button>
                                      <div class="mt-3">
                                        Vous avez déjà des réservations pour cet atelier, vous ne pouvez pas le passer <em>hors ligne</em>.
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>

                        <% elsif workshop.status == 'hors ligne' && workshop.sessions.where(db_status: true).select { |session| session.date >= Date.today }.present? && workshop.completed? %>
                          <a href="/ateliers/<%=workshop.id%>/send_verification_mail" class="button mr-2">Demander la mise en ligne</a>

                        <% elsif workshop.completed? == false || workshop.sessions.where(db_status: true).select { |session| session.date >= Date.today }.present? == false %>
                          <a href="#disabledOnlineModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo" id="turn-online-offline-button-disabled">
                            Passer en ligne
                          </a>

                          <div class="modal fade disabled-modal" id="disabledOnlineModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="disabledOnlineModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <div class="form-group">
                                  <div class="modal-body">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                    </button>
                                    <div class="mt-3">
                                      <% if workshop.completed? %>
                                        Vous n'avez pas de session à venir pour cet atelier, il ne peut donc pas être <em>en ligne</em>. Merci d'ajouter une nouvelle date.
                                      <% else %>
                                        <strong>Les informations concernant l'atelier sont incomplètes.</strong><br>
                                        Informations non renseignées :
                                        <ul>
                                          <% if workshop.title.present? == false %><li>Intitulé de l'atelier</li><% end %>
                                          <% if workshop.title.present? == false %><li>Intitulé de l'atelier</li><% end %>
                                          <% if workshop.thematic.present? == false %><li>Type d'atelier</li><% end %>
                                          <% if workshop.level.present? == false %><li>Niveau requis pour participer</li><% end %>
                                          <% if workshop.duration.present? == false %><li>Durée de l'atelier</li><% end %>
                                          <% if workshop.final_product.present? == false %><li>Nombre de places proposées</li><% end %>
                                          <% if workshop.price.present? == false || workshop.price == 0 %><li>Prix par personne</li><% end %>
                                          <% if workshop.program.present? == false %><li>Programme</li><% end %>
                                          <% if workshop.final_product.present? == false %><li>Repartez avec</li><% end %>
                                        </ul>
                                        Veuillez compléter les informations manquantes en cliquant sur <strong><em>Modifier la fiche</em></strong>.
                                      <% end %>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% end %>
                      <% end %>

                      <% if workshop.place.user == @profile.user %>

                        <% if workshop.status == "hors ligne" && my_ws_bookings_7_days.empty? %>
                          <%= link_to workshop_path(workshop),
                            method: :delete,
                            data: { confirm: "Êtes-vous sûr de vouloir supprimer cet atelier ?" },
                            class: "button",
                            id: "destroy-ws" do %>
                            <i class="far fa-trash-alt"></i>
                          <% end %>
                        <% end %>
                      <% end %>

                      <% if workshop.place.user != @profile.user %>
                        <%= simple_form_for(@chatroom) do |f| %>
                          <%= f.hidden_field :room_name, value: workshop.title %>
                          <%= f.hidden_field :user1, value: current_user.id %>
                          <%= f.hidden_field :user2, value: workshop.place.user.id %>
                          <button type="submit" name="commit" class="button mr-2">
                            </i> Contacter l'organisateur
                          </button>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>

            <% if my_workshops.size == 0 %>
              <p>Vous n'avez pas encore créé d'atelier, <%= link_to "cliquez ici pour commencer !", new_workshop_path %> &#128521;</p>
            <% end %>
          </div>

          <!-- MY AGENDA TO COME -->

          <div class="tab-pane fade" id="v-pills-my-agenda-to-come" role="tabpanel" aria-labelledby="v-pills-my-agenda-to-come-tab">
            <div class="mobile-dashboard-my-agenda">
              <% date_to_come = 0 %>
              <% my_dates.to_set.sort.each do |date| %>
                <% if date >= Date.today %>
                  <% date_to_come += 1 %>
                  <div class="mobile-dashboard-my-agenda-date">
                    <div class="mobile-dashboard-my-agenda-date-title">
                      <h2><%= l(date, format: '%A %d %B %Y').capitalize %></h2>
                    </div>
                    <div class="mobile-dashboard-my-agenda-date-container">
                      <% Session.where("date = ?", date.strftime).where(db_status: true).select {|s| s.workshop.verified == true && s.workshop.status == "en ligne" }.sort_by { |session| session.start_at }.each do |session| %>
                        <% if session.workshop.place.user == @profile.user || (session.workshop.animators.where(db_status: true).last.user == @profile.user if session.workshop.animators.where(db_status: true).present?) %>
                          <div class="mobile-dashboard-my-agenda-workshop">
                            <%= link_to workshop_path(session.workshop) do  %>
                              <% session_start_time = Time.new(Date.today.strftime('%Y').to_i, Date.today.strftime('%m').to_i, Date.today.strftime('%d').to_i, session.start_at[0..1], session.start_at[-2..-1], 0, "+01:00") %>
                              <% session_end_time = session_start_time + session.workshop.duration.minutes %>
                              <% if session.workshop.title.size > 33 %>
                                <h3><%= session_start_time.strftime("%Hh%M") %> à <%= session_end_time.strftime("%Hh%M") %> - <%= session.workshop.title[0..30] %>...</h3>
                              <% else %>
                                <h3><%= session_start_time.strftime("%Hh%M") %> à <%= session_end_time.strftime("%Hh%M") %> - <%= session.workshop.title %></h3>
                              <% end %>
                            <% end %>

                            <div class="mobile-dashboard-my-agenda-workshop-infos">

                              <% if session.workshop.place.user == @profile.user %>
                                <h4 class="mobile-my-agenda-ws-animator">
                                  <i class="fas fa-user-shield mr-1"></i>
                                  <strong>Vous êtes organisateur</strong>
                                </h4>
                              <% else %>
                                <h4 class="mobile-my-agenda-ws-animator">
                                  <i class="fas fa-graduation-cap mr-1"></i>
                                  <strong>Vous êtes animateur</strong>
                                </h4>
                              <% end %>

                              <h4 class="mobile-my-agenda-ws-place-name">
                                <% if session.workshop.visio == true %>
                                  <i class="fas fa-video mr-2"></i>
                                  En visioconférence
                                <% else %>
                                  <%= link_to "https://www.google.fr/maps/search/#{session.workshop.place.address}, #{session.workshop.place.zip_code} #{session.workshop.place.city.upcase}", target: "_blank" do %>
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    Chez <%= session.workshop.place.name %> au <%= "#{session.workshop.place.address}, #{session.workshop.place.zip_code} #{session.workshop.place.city.capitalize}" %>
                                  <% end %>
                                <% end %>
                              </h4>

                              <% if session.workshop.place.user == @profile.user %>
                                <% if session.workshop.animators.where(db_status: true).last %>
                                  <h4 class="mobile-my-agenda-ws-animator">
                                    <i class="fas fa-graduation-cap mr-1"></i>
                                    Animé par <%= session.workshop.animators.where(db_status: true).last.user.profile.company %>
                                  </h4>
                                <% end %>
                              <% else %>
                                <h4 class="mobile-my-agenda-ws-animator">
                                  <i class="fas fa-user-shield mr-1"></i>
                                  Organisé par <%= session.workshop.place.user.profile.company %>
                                </h4>
                              <% end %>

                              <h4 class="mobile-my-agenda-ws-duration">
                                <i class="far fa-clock mr-2"></i>
                                <% if session.workshop.duration%60 == 0 %>
                                  <%= session.workshop.duration/60 %> heures
                                <% else %>
                                  <%= session.workshop.duration/60 %> heures <%= session.workshop.duration%60 %>
                                <% end %>
                              </h4>
                              <h4 class="mobile-my-agenda-ws-sessions">
                                <i class="fas fa-ticket-alt mr-1"></i>
                                <% if session.available > 1 %>
                                  <%= session.available %> places restantes / <%= session.capacity %>
                                <% else %>
                                  <%= session.available %> place restante / <%= session.capacity %>
                                <% end %>
                              </h4>
                            </div>
                            <div class="mobile-dashboard-my-agenda-workshop-participants">
                              <% if (session.available == session.capacity) && (session.workshop.place.user == @profile.user) %>
                                <%= link_to "Déprogrammer la session",
                                session_path(session),
                                method: :delete,
                                data: { confirm: "Êtes-vous sûr?" },
                                class: "button" %>
                              <% elsif session.available != session.capacity %>
                                <%= link_to "Voir et contacter les participants", session_participants_path(session), class: "button mr-1" %>
                                <% if session.workshop.visio == true %>
                                  <%= link_to "Envoyer les infos visio", session_informations_visioconference_path(session), class: "button" %>
                                <% end %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
              <% if date_to_come == 0 %>
                Votre planning est vide, vous n'avez aucune session à venir.
              <% end %>
            </div>
          </div>


          <!-- MY AGENDA PASSED -->

          <div class="tab-pane fade" id="v-pills-my-agenda-passed" role="tabpanel" aria-labelledby="v-pills-my-agenda-passed-tab">
            <div class="mobile-dashboard-my-agenda">
              <% date_passed = 0 %>
              <% my_dates.to_set.sort.reverse.each do |date| %>
                <% if date < Date.today %>
                  <% date_passed += 1 %>
                  <div class="mobile-dashboard-my-agenda-date">
                    <div class="mobile-dashboard-my-agenda-date-title" id="mobile-dashboard-my-passed-agenda-date-title">
                      <h2><%= l(date, format: '%A %d %B %Y').capitalize %></h2>
                    </div>
                    <div class="mobile-dashboard-my-agenda-date-container">
                      <% Session.where("date = ?", date.strftime).where(db_status: true).sort_by { |session| session.start_at }.each do |session| %>
                        <% if session.workshop.place.user == @profile.user || (session.workshop.animators.where(db_status: true).last.user == @profile.user if session.workshop.animators.where(db_status: true).present?) %>
                          <div class="mobile-dashboard-my-agenda-workshop" id="mobile-dashboard-my-passed-agenda-workshop">
                            <%= link_to workshop_path(session.workshop) do  %>
                              <% session_start_time = Time.new(Date.today.strftime('%Y').to_i, Date.today.strftime('%m').to_i, Date.today.strftime('%d').to_i, session.start_at[0..1], session.start_at[-2..-1], 0, "+01:00") %>
                              <% session_end_time = session_start_time + session.workshop.duration.minutes %>
                              <% if session.workshop.title.size > 33 %>
                                <h3><%= session_start_time.strftime("%Hh%M") %> à <%= session_end_time.strftime("%Hh%M") %> - <%= session.workshop.title[0..30] %>...</h3>
                              <% else %>
                                <h3><%= session_start_time.strftime("%Hh%M") %> à <%= session_end_time.strftime("%Hh%M") %> - <%= session.workshop.title %></h3>
                              <% end %>
                            <% end %>

                            <div class="mobile-dashboard-my-agenda-workshop-infos">

                              <% if session.workshop.place.user == @profile.user %>
                                <h4 class="mobile-my-agenda-ws-animator">
                                  <i class="fas fa-user-shield mr-1"></i>
                                  <strong>Vous étiez organisateur</strong>
                                </h4>
                              <% else %>
                                <h4 class="mobile-my-agenda-ws-animator">
                                  <i class="fas fa-graduation-cap mr-1"></i>
                                  <strong>Vous étiez animateur</strong>
                                </h4>
                              <% end %>

                              <h4 class="mobile-my-agenda-ws-place-name">
                                <% if session.workshop.visio == true %>
                                  <i class="fas fa-video mr-2"></i>
                                  En visioconférence
                                <% else %>
                                  <%= link_to "https://www.google.fr/maps/search/#{session.workshop.place.address}, #{session.workshop.place.zip_code} #{session.workshop.place.city.upcase}", target: "_blank" do %>
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    Chez <%= session.workshop.place.name %> au <%= "#{session.workshop.place.address}, #{session.workshop.place.zip_code} #{session.workshop.place.city.capitalize}" %>
                                  <% end %>
                                <% end %>
                              </h4>

                              <% if session.workshop.place.user == @profile.user %>
                                <% if session.workshop.animators.where(db_status: true).last %>
                                  <h4 class="mobile-my-agenda-ws-animator">
                                    <i class="fas fa-graduation-cap mr-1"></i>
                                    Animé par <%= session.workshop.animators.where(db_status: true).last.user.profile.company %>
                                  </h4>
                                <% end %>
                              <% else %>
                                <h4 class="mobile-my-agenda-ws-animator">
                                  <i class="fas fa-user-shield mr-1"></i>
                                  Organisé par <%= session.workshop.place.user.profile.company %>
                                </h4>
                              <% end %>

                              <h4 class="mobile-my-agenda-ws-duration">
                                <i class="far fa-clock mr-2"></i>
                                <% if session.workshop.duration%60 == 0 %>
                                  <%= session.workshop.duration/60 %> heures
                                <% else %>
                                  <%= session.workshop.duration/60 %> heures <%= session.workshop.duration%60 %>
                                <% end %>
                              </h4>
                              <h4 class="mobile-my-agenda-ws-sessions" id="mobile-my-passed-agenda-ws-sessions">
                                <i class="fas fa-ticket-alt mr-1"></i>
                                <% if session.sold > 1 %>
                                  <%= session.sold %> places vendues / <%= session.capacity %>
                                <% else %>
                                  <%= session.sold %> place vendue / <%= session.capacity %>
                                <% end %>
                              </h4>
                            </div>
                            <div class="mobile-dashboard-my-agenda-workshop-participants">
                              <% if session.available != session.capacity %>
                                <%= link_to "Voir les participants", session_participants_path(session), class: "button" %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
              <% if date_passed == 0 %>
                Votre planning passé est vide, vous n'avez aucune session passée.
              <% end %>
            </div>
          </div>




          <!-- KITS SENDING -->

          <div class="tab-pane fade" id="v-pills-kits-sending" role="tabpanel" aria-labelledby="v-pills-kits-sending-tab">

            <div class="dashboard-my-kits-sending">
              <% if my_sessions.select { |s| s.date >= Date.today && s.workshop.kit == true}.count > 0 %>
                <% my_sessions.select { |s| s.date >= Date.today && s.workshop.kit == true}.sort_by { |s| s.date }.each do |session| %>

                  <div class="dashboard-my-kits-sending-workshop">
                    <div class="dashboard-my-kits-sending-image">
                      <%= link_to workshop_path(session.workshop) do  %>
                        <% if session.workshop.photos.attached? %>
                          <%= cl_image_tag session.workshop.photos[0].key, loading: "lazy", alt: "jeu-de-mains-#{session.workshop.title}", title: "jeu-de-mains-#{session.workshop.title}", width: 130, height: 160, crop: :fill %>
                        <% else %>
                          <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593177818/jeu-de-mains-atelier.jpg", :loading => "lazy", :width => 130, :height => 160, :crop => :fill, :alt => "jeu-de-mains-#{session.workshop.title}", :title => "jeu-de-mains-#{session.workshop.title}") %>
                        <% end %>
                      <% end %>
                    </div>
                    <div class="dashboard-my-kits-sending-infos">
                      <div>
                        <p class="dashboard-my-kits-sending-coming">
                          <i class="fas fa-clock mr-2"></i>
                          Visio dans <%= ((session.date.to_time - Time.now.to_time) / 1.days).round %> jours
                        </p>
                        <p class="dashboard-my-kits-sending-participants">
                          <i class="fas fa-user-check mr-1"></i>
                          <%= session.sold > 1 ? "#{session.sold} participants inscrits" : "#{session.sold} participant inscrit"%>
                        </p>
                        <h2>
                          <%= link_to workshop_path(session.workshop) do  %>
                            Kit pour <%= session.workshop.title %>
                          <% end %>
                        </h2>
                        <h3>
                          <%= l(session.date, format: '%A %d %B %Y').capitalize %>
                        </h3>
                        <h3>À <%= session.start_at %></h3>
                        <h3>Clôture des réservations le <%= l((session.date - 7.days), format: '%d %B') %></h3>
                      </div>
                      <div class="mt-2 mb-1">
                        <%= link_to "Gérer l'expédition", session_expedition_kits_path(session), class: "dashboard-my-kits-sending-button" %>
                      </div>
                    </div>

                  </div>
                <% end %>
              <% else %>
                <p>Vous n'avez aucun atelier en visio avec kit à venir. <br>
                Pour créer un atelier en visio, il vous suffit de créer un atelier classique et de sélectionner "Atelier en visio" comme lieu ;)</p>
                <strong><%= link_to "Créer un atelier", new_workshop_path %></strong>
              <% end %>
            </div>
          </div>

          <!-- MY REVIEWS -->

          <div class="tab-pane fade" id="v-pills-my-reviews" role="tabpanel" aria-labelledby="v-pills-my-reviews-tab">
            <div class="dashboard-my-reviews">
              <% if @profile.true_and_false_reviews.count > 0 %>
                <p id="dashboard-reviews-description">
                  Cliquez sur la ligne concernée pour voir le message, l'atelier et le lieu.<br>
                  Vous pouvez signaler un avis qui vous semble inapproprié si la note est inférieure ou égale à 2/5.<br>
                  Vous souhaitez signaler un autre avis ? <%= link_to "Écrivez à l'équipe Jeu de Mains." , nous_contacter_path %>
                </p>

                <div class="dashboard-reviews-legends">
                  <div class="d-flex mr-2">
                    <div class="dashboard-reviews-legend-is-online"></div>
                    Avis publiés (<%= @profile.reviews.count %>)
                  </div>
                  <div class='d-flex'>
                    <div class="dashboard-reviews-legend-is-offline"></div>
                    Avis supprimés (<%= @profile.true_and_false_reviews.count - @profile.reviews.count %>)
                  </div>
                </div>

                <div class="accordion" id="accordionDashboardReviews">
                  <% @profile.true_and_false_reviews.sort_by { |review| review.created_at }.reverse.each_with_index do |review, index| %>
                    <div class="card">
                      <% if review.db_status == true %>
                        <div class="card-header review-is-online" id="heading<%= index %>">
                      <% else %>
                        <div class="card-header review-is-offline" id="heading<%= index %>">
                      <% end %>
                        <div class="dashboard-one-review collapsed" type="button" data-toggle="collapse" data-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                          <div><%= review.created_at.strftime("%d/%m/%y") %></div>
                          <div class="d-flex justify-content-center align-items-center"><%= review.rating %><i class="fas fa-star"></i></div>
                          <div><%= review.user.first_name %></div>
                          <% if review.rating <= 2 && review.db_status == true %>
                            <div class="d-flex justify-content-end align-items-center">
                              <%= simple_form_for :report, url: review_report_review_path(review), method: :get do |f| %>
                                <%= f.hidden_field :review_id, value: review.id %>
                                <%= f.submit "Signaler", data: { confirm: "Êtes-vous sûr de vouloir signaler cet avis ? Il sera dépublié instantanément et nos équipes procéderont ensuite à une vérification de cet avis." }, class: "button" %>
                              <% end %>
                            </div>
                            <div class="d-flex justify-content-end align-items-center">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                          <% end %>
                        </div>
                      </div>
                      <div id="collapse<%= index %>" class="collapse" aria-labelledby="heading<%= index %>" data-parent="#accordionDashboardReviews">
                        <div class="card-body">
                          <strong>Atelier</strong><br>
                          <%= review.booking.session.workshop.title %><br>
                          <strong>Lieu</strong><br>
                          <%= review.booking.session.workshop.place.name %><br>
                          <strong>Message</strong><br>
                          <%= review.content %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                Vous n'avez pas encore reçu d'avis.
              <% end %>
            </div>
          </div>


          <!-- MY KPIs -->


          <% my_bookings_kpi_7_days = 0 %>
          <% my_bookings_kpi_30_days = 0 %>
          <% my_sessions.each do |session| %>
            <% session.bookings.where(db_status: true, status: "paid").each do |booking| %>
              <% if booking.created_at >= Date.today - 7 %>
                <% my_bookings_kpi_7_days += booking.quantity %>
              <% elsif booking.created_at >= Date.today - 30 %>
                <% my_bookings_kpi_30_days += booking.quantity %>
              <% end %>
            <% end %>
          <% end %>

          <% my_cancels_kpi_7_days = 0 %>
          <% my_cancels_kpi_30_days = 0 %>
          <% canceled_bookings.each do |booking| %>
            <% if booking.cancelled_at.present? %>
              <% if booking.cancelled_at >= Date.today - 7 %>
                <% my_cancels_kpi_7_days += booking.quantity %>
              <% elsif booking.cancelled_at >= Date.today - 30 %>
                <% my_cancels_kpi_30_days += booking.quantity %>
              <% end %>
            <% else %>
              <% if booking.updated_at >= Date.today - 7 %>
                <% my_cancels_kpi_7_days += booking.quantity %>
              <% elsif booking.updated_at >= Date.today - 30 %>
                <% my_cancels_kpi_30_days += booking.quantity %>
              <% end %>
            <% end %>
          <% end %>

          <div class="tab-pane fade" id="v-pills-my-kpis" role="tabpanel" aria-labelledby="v-pills-my-kpis-tab">
            <div class="dashboard-my-kpis">
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-bookings">
                <h2 class="my-bookings-seven-days active"><%= my_bookings_kpi_7_days %></h2>
                <h2 class="my-bookings-thirty-days"><%= my_bookings_kpi_7_days + my_bookings_kpi_30_days %></h2>
                <h3>réservation.s<br>passée.s depuis</h3>
                <label class="switch mt-1">
                  <input type="checkbox" id="togBtnBookings">
                    <div class="slider slider-bookings round">
                      <span class="on">7 jours</span>
                      <span class="off">30 jours</span>
                    </div>
                </label>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-cancellations">
                <h2 class="my-cancellations-seven-days active"><%= my_cancels_kpi_7_days %></h2>
                <h2 class="my-cancellations-thirty-days"><%= my_cancels_kpi_7_days + my_cancels_kpi_30_days %></h2>
                <h3>réservation.s<br>annulée.s depuis</h3>
                <label class="switch mt-1">
                  <input type="checkbox" id="togBtnCancellations">
                    <div class="slider slider-cancellations round">
                      <span class="on">7 jours</span>
                      <span class="off">30 jours</span>
                    </div>
                </label>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-workshops">
                <h2><%= my_workshops.select { |w| w.status == "en ligne" && w.verified == true }.count %></h2>
                <% if my_workshops.select { |w| w.status == "en ligne" && w.verified == true }.count > 1 %>
                  <h3>ateliers<br>en ligne</h3>
                <% else %>
                  <h3>atelier<br>en ligne</h3>
                <% end %>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-sessions">
                <h2><%= my_sessions.select { |s| s.date >= Date.today && s.workshop.verified == true }.count %></h2>
                <% if my_sessions.select { |s| s.date >= Date.today && s.workshop.verified == true }.count > 1 %>
                  <h3>créneaux à venir</h3>
                <% else %>
                  <h3>créneau à venir</h3>
                <% end %>
              </div>

              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-rating">
                <% if @profile.reviews.count > 0 %>
                  <h2><%= @profile.rating.round(2) %></h2>
                  <h3>note globale<br> sur 5</h3>
                <% else %>
                  <h3>Vous n'avez pas<br>encore de note</h3>
                <% end %>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-reviews">
                <% if @profile.reviews.count > 0 %>
                  <h2><%= @profile.reviews.count %></h2>
                  <% if @profile.reviews.count > 1 %>
                    <h3>avis reçus publiés</h3>
                  <% else %>
                    <h3>avis reçu publié</h3>
                  <% end %>
                <% else %>
                  <h3>Vous n'avez pas<br>encore d'avis</h3>
                <% end %>
              </div>

            </div>
          </div>

          <!-- MY TRANSACTIONS -->

          <div class="tab-pane fade" id="v-pills-my-transactions" role="tabpanel" aria-labelledby="v-pills-my-transactions-tab">
            <%= render 'dashboard_transactions' %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
