<% if @profile.user == current_user %>

  <!-- DASHBOARD - ORGANIZER -->

  <div class="dashboard-title-container" id="dashboard-organizer-title-container">
    <h1>
      Hello <span><%= @profile.company %></span>,<br>bienvenue sur votre tableau de bord !
    </h1>
  </div>

  <div class="dashboard-organizer-container">
    <div class="dashboard-contact-us">
      <%= link_to contact_path do %>
        <i class="fas fa-question"></i>
      <% end %>
    </div>
    <div class="dashboard-nav-and-tab" id="dashboard-organizer-nav-and-tab">

      <!-- NAV PILLS DESKTOP & TABLET -->

      <div class="dashboard-nav-desktop-tablet">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <a class="nav-link active" id="v-pills-my-workshops-tab" data-toggle="pill" href="#v-pills-my-workshops" role="tab" aria-controls="v-pills-my-workshops" aria-selected="true">
            Mes ateliers
          </a>
          <a class="nav-link" id="v-pills-my-agenda-tab" data-toggle="pill" href="#v-pills-my-agenda" role="tab" aria-controls="v-pills-my-agenda" aria-selected="false">
            Mon planning
          </a>
          <a class="nav-link" id="v-pills-my-kpis-tab" data-toggle="pill" href="#v-pills-my-kpis" role="tab" aria-controls="v-pills-my-kpis" aria-selected="false">
            Mes chiffres clés
          </a>
          <a class="nav-link" id="v-pills-my-transactions-tab" data-toggle="pill" href="#v-pills-my-transactions" role="tab" aria-controls="v-pills-my-transactions" aria-selected="false">
            Mes transactions
          </a>
        </div>
      </div>

      <!-- NAV PILLS MOBILE -->

      <div class="dashboard-nav-mobile">
        <div class="nav nav-pills nav-pills-organizer" id="pills-tab" role="tablist">
          <a class="nav-link active" id="v-pills-my-workshops-tab" data-toggle="pill" href="#v-pills-my-workshops" role="tab" aria-controls="v-pills-my-workshops" aria-selected="true">
            <span>Mes ateliers</span>
          </a>
          <a class="nav-link" id="v-pills-my-agenda-tab" data-toggle="pill" href="#v-pills-my-agenda" role="tab" aria-controls="v-pills-my-agenda" aria-selected="false">
            <span>Mon planning</span>
          </a>
          <a class="nav-link" id="v-pills-my-kpis-tab" data-toggle="pill" href="#v-pills-my-kpis" role="tab" aria-controls="v-pills-my-kpis" aria-selected="false">
            <span>Mes chiffres clés</span>
          </a>
          <a class="nav-link" id="v-pills-my-transactions-tab" data-toggle="pill" href="#v-pills-my-transactions" role="tab" aria-controls="v-pills-my-transactions" aria-selected="false">
            <span>Mes transactions</span>
          </a>
        </div>
      </div>

      <!-- NAV TABS -->

      <div class="dashboard-tabs" id="dashboard-organizer-tabs">
        <div class="tab-content" id="pills-tabContent">
          <% my_workshops = [] %>
          <% my_sessions = [] %>
          <% my_dates = [] %>
          <% @profile.user.animators.where(db_status: true).each do |animator| %>
            <% if animator.workshop.db_status == true  %>
              <% my_workshops << animator.workshop %>
              <% animator.workshop.sessions.where(db_status: true).each do |session| %>
                <% my_sessions << session %>
                <% my_dates << session.date %>
              <% end %>
            <% end %>
          <% end %>

          <!-- MY WORKSHOPS -->

          <div class="tab-pane fade show active" id="v-pills-my-workshops" role="tabpanel" aria-labelledby="v-pills-my-workshops-tab">
            <% my_sorted_workshops = [] %>
            <% my_offline_workshops = [] %>
            <% my_workshops.sort_by { |workshop| workshop.created_at }.each do |workshop| %>
              <% if workshop.status == "en ligne" %>
                <% my_sorted_workshops << workshop %>
              <% else %>
                <% my_offline_workshops << workshop %>
              <% end %>
            <% end %>
            <% my_offline_workshops.each do |workshop| %>
              <% my_sorted_workshops << workshop %>
            <% end %>

            <%= link_to profile_public_path(@profile), id: "dashboard-show-my-public-profile" do %>
              <i class="fas fa-chevron-right mr-1"></i>
              <span>Voir ma page publique</span>
            <% end %>

            <% my_sorted_workshops.each_with_index do |workshop, index| %>

              <% my_ws_bookings_7_days = [] %>
              <% my_ws_bookings_today = [] %>
              <% all_my_ws_bookings = [] %>
              <% workshop.sessions.where(db_status: true).each do |session| %>
                <% if session.date >= Date.today - 7 %>
                  <% session.bookings.where(db_status: true).each do |booking| %>
                    <% my_ws_bookings_7_days << booking %>
                  <% end %>
                <% end %>
                <% if session.date >= Date.today %>
                  <% session.bookings.where(db_status: true).each do |booking| %>
                    <% my_ws_bookings_today << booking %>
                  <% end %>
                <% end %>
                <% session.bookings.where(db_status: true).each do |booking| %>
                  <% all_my_ws_bookings << booking %>
                <% end %>
              <% end %>

              <% if workshop.status == "en ligne" %>
                <div class="ws-dashboard-organizer-card-container">
              <% else %>
                <div class="ws-dashboard-organizer-card-container" id="offline-ws">
              <% end %>
                <div class="ws-dashboard-organizer-card">
                  <div class="ws-dashboard-organizer-image">
                    <% if workshop.photos.attached? %>
                      <%= cl_image_tag workshop.photos[0].key, loading: "lazy", alt: "jeu-de-mains-#{workshop.title}", title: "jeu-de-mains-#{workshop.title}", width: 95, height: 95, crop: :fill %>
                    <% else %>
                      <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593177818/jeu-de-mains-atelier.jpg", :loading => "lazy", :width => 95, :height => 95, :crop => :fill, :alt => "jeu-de-mains-#{workshop.title}", :title => "jeu-de-mains-#{workshop.title}") %>
                    <% end %>
                  </div>
                  <div class="ws-dashboard-organizer-text-and-buttons">
                    <div class="ws-dashboard-organizer-text">
                      <%= link_to workshop_path(workshop) do %>
                        <% if workshop.title.size > 28 %>
                          <h2><%= workshop.title[0..26] %>...</h2>
                        <% else %>
                          <h2><%= workshop.title %></h2>
                        <% end %>
                      <% end %>
                      <% if workshop.place.name.size > 30 %>
                        <h3><%= workshop.place.name[0..28] %>...</h3>
                      <% else %>
                        <h3><%= workshop.place.name %></h3>
                      <% end %>
                      <span><%= workshop.status.capitalize %></span>
                    </div>
                    <div class="show-actions-button show-actions-button-<%= index +1 %> active" id="showActionsButtons-<%= index +1 %>">
                      <%= link_to "Gérer", "#", class: "button" %>
                    </div>
                    <div class="ws-dashboard-organizer-buttons" id="ws-dashboard-organizer-buttons-<%= index +1 %>">
                      <div>
                        <a href="#addSessionModal<%= index +1 %>" class="button mr-2" data-toggle="modal" data-whatever="@mdo" id="add-date-button">
                          <i class="fas fa-plus mr-1"></i>
                          <span>Ajouter une date</span>
                        </a>

                        <div class="modal fade add-session-modal" id="addSessionModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="addSessionModalLabel" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">

                              <div class="form-group">
                                <%= simple_form_for([workshop, @session]) do |f| %>
                                  <div class="modal-body">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                    </button>

                                    <%= f.input :date, label: "Date de l'atelier" %>
                                    <%= f.input :start_at, label: "Heure de début", collection: Session::STARTS_AT %>
                                    <%= f.input :capacity, label: "Nombre de places si différent de celui indiqué dans la fiche atelier" %>

                                    <div class="d-flex justify-content-center">
                                      <%= f.submit 'Valider', class: "new-edit-ws-submit" %>
                                    </div>

                                  </div>
                                <% end %>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <%= link_to "Modifier la fiche", edit_workshop_path(workshop), class: "button mr-2" %>
                      <%= link_to "Gérer les sessions", workshop_sessions_path(workshop), class: "button mr-2" %>

                      <% if workshop.status == "en ligne" && my_ws_bookings_today.empty? %>
                        <%= form_for workshop, method: :patch do |f| %>
                          <%= f.hidden_field :status, value: 'hors ligne' %>
                          <%= f.submit 'Passer hors ligne', class: "button", id: "turn-online-offline-button" %>
                        <% end %>
                      <% elsif workshop.status == "en ligne" && my_ws_bookings_today.size > 0 %>
                        <a href="#disabledModal<%= index +1 %>" class="button" data-toggle="modal" data-whatever="@mdo" id="turn-online-offline-button-disabled">
                            Passer hors ligne
                          </a>

                        <div class="modal fade disabled-modal" id="disabledModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="disabledModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <div class="form-group">
                                  <div class="modal-body">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                    </button>
                                    <div class="mt-3">
                                      Vous avez déjà des réservations pour cet atelier, vous ne pouvez pas le passer <em>hors ligne</em>.
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                      <% elsif workshop.status == 'hors ligne' && workshop.sessions.select { |session| session.date >= Date.today }.present? %>
                        <%= form_for workshop, method: :patch do |f| %>
                          <%= f.hidden_field :status, value: 'en ligne' %>
                          <%= f.submit 'Passer en ligne', class: "button", id: "turn-online-offline-button" %>
                        <% end %>
                      <% else %>
                        <a href="#disabledOnlineModal<%= index +1 %>" class="button" data-toggle="modal" data-whatever="@mdo" id="turn-online-offline-button-disabled">
                            Passer en ligne
                          </a>

                          <div class="modal fade disabled-modal" id="disabledOnlineModal<%= index +1 %>" tabindex="-1" role="dialog" aria-labelledby="disabledOnlineModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                              <div class="modal-content">
                                <div class="form-group">
                                  <div class="modal-body">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                      <%= cl_image_tag("https://res.cloudinary.com/jeudemains/image/upload/v1593191048/jeu-de-mains-fermer-bleu.svg", :width => 50, :height => 50, :crop => :fill, :alt => "jeu-de-mains-fermer", :title => "jeu-de-mains-fermer") %>
                                    </button>
                                    <div class="mt-3">
                                      Vous n'avez pas de session à venir pour cet atelier, il ne peut donc pas être <em>en ligne</em>. Merci d'ajouter une nouvelle date.
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                      <% end %>

                    </div>
                  </div>
                </div>
              </div>
            <% end %>
            <% if my_workshops.size == 0 %>
              <p>Vous n'avez pas encore d'atelier.</p>
            <% end %>
          </div>

          <!-- MY AGENDA -->

          <div class="tab-pane fade" id="v-pills-my-agenda" role="tabpanel" aria-labelledby="v-pills-my-agenda-tab">
            <div class="mobile-dashboard-my-agenda">
              <% date_to_come = 0 %>
              <% my_dates.to_set.sort.each do |date| %>
                <% if date >= Date.today %>
                  <% date_to_come += 1 %>
                  <div class="mobile-dashboard-my-agenda-date">
                    <div class="mobile-dashboard-my-agenda-date-title">
                      <h2><%= l(date, format: '%A %d %B %Y').capitalize %></h2>
                    </div>
                    <div class="mobile-dashboard-my-agenda-date-container">
                      <% Session.where("date = ?", date.strftime).where(db_status: true).sort_by { |session| session.start_at }.each do |session| %>
                        <% if session.workshop.animators.where(db_status: true).first.user == @profile.user %>
                          <div class="mobile-dashboard-my-agenda-workshop">
                            <%= link_to workshop_path(session.workshop) do  %>
                              <% if session.workshop.title.size > 33 %>
                                <h3><%=session.start_at%> - <%= session.workshop.title[0..30] %>...</h3>
                              <% else %>
                                <h3><%=session.start_at%> - <%= session.workshop.title %></h3>
                              <% end %>
                            <% end %>
                            <div class="mobile-dashboard-my-agenda-workshop-infos">
                              <h4 class="mobile-my-agenda-ws-place-name">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <%= session.workshop.place.name %>
                              </h4>
                              <h4 class="mobile-my-agenda-ws-duration">
                                <i class="far fa-clock mr-2"></i>
                                <% if session.workshop.duration%60 == 0 %>
                                  <%= session.workshop.duration/60 %> heures
                                <% else %>
                                  <%= session.workshop.duration/60 %> heures <%= session.workshop.duration%60 %>
                                <% end %>
                              </h4>
                              <h4 class="mobile-my-agenda-ws-sessions">
                                <i class="fas fa-ticket-alt mr-1"></i>
                                <%= session.available %> places restantes / <%= session.capacity %>
                              </h4>
                            </div>
                            <div class="mobile-dashboard-my-agenda-workshop-participants">
                              <% if session.available == session.capacity %>
                                <%= link_to "Déprogrammer la session",
                                session_path(session),
                                method: :delete,
                                data: { confirm: "Êtes-vous sûr?" },
                                class: "button" %>
                              <% else %>
                                <%= link_to "Voir et contacter les participants", session_participants_path(session), class: "button" %>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>
              <% if date_to_come == 0 %>
                Votre planning est vide, vous n'avez aucune session à venir.
              <% end %>
            </div>
          </div>


          <!-- MY KPIs -->


          <% my_bookings_kpi_7_days = 0 %>
          <% my_bookings_kpi_30_days = 0 %>
          <% my_sessions.each do |session| %>
            <% session.bookings.where(db_status: true).each do |booking| %>
              <% if booking.created_at >= Date.today - 7 %>
                <% my_bookings_kpi_7_days += booking.quantity %>
              <% elsif booking.created_at >= Date.today - 30 %>
                <% my_bookings_kpi_30_days += booking.quantity %>
              <% end %>
            <% end %>
          <% end %>

          <% my_cancels_kpi_7_days = 0 %>
          <% my_cancels_kpi_30_days = 0 %>
          <% @profile.user.animators.where(db_status: true).each do |animator| %>
            <% if animator.workshop.db_status == true %>
              <% animator.workshop.sessions.where(db_status: true).each do |session| %>
                <% session.bookings.where(db_status: false).each do |booking| %>
                  <% if booking.updated_at >= Date.today - 7 %>
                    <% my_cancels_kpi_7_days += booking.quantity %>
                  <% elsif booking.updated_at >= Date.today - 30 %>
                    <% my_cancels_kpi_30_days += booking.quantity %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>


          <div class="tab-pane fade" id="v-pills-my-kpis" role="tabpanel" aria-labelledby="v-pills-my-kpis-tab">
            <div class="dashboard-my-kpis">
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-bookings">
                <h2 class="my-bookings-seven-days active"><%= my_bookings_kpi_7_days %></h2>
                <h2 class="my-bookings-thirty-days"><%= my_bookings_kpi_7_days + my_bookings_kpi_30_days %></h2>
                <h3>réservation.s<br>passée.s depuis</h3>
                <label class="switch mt-1">
                  <input type="checkbox" id="togBtnBookings">
                    <div class="slider slider-bookings round">
                      <span class="on">7 jours</span>
                      <span class="off">30 jours</span>
                    </div>
                </label>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-cancellations">
                <h2 class="my-cancellations-seven-days active"><%= my_cancels_kpi_7_days %></h2>
                <h2 class="my-cancellations-thirty-days"><%= my_cancels_kpi_7_days + my_cancels_kpi_30_days %></h2>
                <h3>réservation.s<br>annulée.s depuis</h3>
                <label class="switch mt-1">
                  <input type="checkbox" id="togBtnCancellations">
                    <div class="slider slider-cancellations round">
                      <span class="on">7 jours</span>
                      <span class="off">30 jours</span>
                    </div>
                </label>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-workshops">
                <h2><%= my_sorted_workshops.count - my_offline_workshops.count %></h2>
                <% if my_sorted_workshops.count - my_offline_workshops.count > 1 %>
                  <h3>ateliers<br>en ligne</h3>
                <% else %>
                  <h3>atelier<br>en ligne</h3>
                <% end %>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-sessions">
                <h2><%= my_sessions.count %></h2>
                <% if my_sessions.count > 1 %>
                  <h3>créneaux<br>proposés</h3>
                <% else %>
                  <h3>créneau<br>proposé</h3>
                <% end %>
              </div>

              <% my_ratings_sum = 0 %>
              <% my_ratings_number = 0 %>
              <% @profile.user.animators.where(db_status: true).each do |animator| %>
                <% if animator.workshop.reviews.present? %>
                  <% animator.workshop.reviews.where(db_status: true).each do |review| %>
                    <% my_ratings_sum += review.rating %>
                    <% my_ratings_number += 1 %>
                  <% end %>
                <% end %>
              <% end %>

              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-rating">
                <% if my_ratings_sum > 0 %>
                  <h2><%= my_ratings_sum.fdiv(my_ratings_number).round(2) %></h2>
                  <h3>note globale<br> sur 5</h3>
                <% else %>
                  <h3>Vous n'avez pas<br>encore de note</h3>
                <% end %>
              </div>
              <div class="dashboard-my-kpis-item" id="dashboard-my-kpis-reviews">
                <% if my_ratings_number > 0 %>
                  <h2><%= my_ratings_number.round %></h2>
                  <% if my_ratings_number > 1 %>
                    <h3>avis reçus</h3>
                  <% else %>
                    <h3>avis reçu</h3>
                  <% end %>
                  <a href="#dashboardreviewsModal" class="my-kpis-button mt-1" data-toggle="modal" data-whatever="@mdo">Consulter</a>
                  <%= render 'dashboard_animator_modal', profile: @profile %>
                <% else %>
                  <h3>Vous n'avez pas<br>encore d'avis</h3>
                <% end %>
              </div>

            </div>
          </div>

          <!-- MY TRANSACTIONS -->

          <div class="tab-pane fade" id="v-pills-my-transactions" role="tabpanel" aria-labelledby="v-pills-my-transactions-tab">
            mes transactions (à coder plus tard, une fois stripe inclus)
          </div>

        </div>
      </div>
    </div>
  </div>

<% end %>
