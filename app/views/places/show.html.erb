<!-- PLACE SHOW -->

<div class="place-show-container profile-container">

  <!-- BACK BUTTON -->

  <div class="back-button">
    <%= link_to :back do %>
      <i class="fas fa-chevron-left"></i>
      <span>Retour</span>
    <% end %>
  </div>

  <!-- HEADER PROFILE -->

  <div class="public-profile-header">
    <div class="public-profile-picture">
      <% if @place.photo.attached? %>
        <%= cl_image_tag @place.photo.key, width: 300, crop: :fill, alt: "photo du lieu" %>
      <% else %>
        <%= cl_image_tag("https://res.cloudinary.com/eugeniedenis/image/upload/v1593177823/profile-picture.png", :width => 300, :crop => :fill, :alt => "photo du lieu") %>
      <% end %>
    </div>
    <div class="public-profile-header-text">
      <div class="public-profile-name">
        <h1><%= @place.name %></h1>
      </div>
      <div class="public-profile-address">
        <%= link_to "https://www.google.fr/maps/search/#{@place.address}, #{@place.zip_code} #{@place.city.upcase}", target: "_blank" do %>
          <i class="fas fa-map-marker-alt"></i>
          <%= "#{@place.address}, #{@place.zip_code} #{@place.city.capitalize}" %>
        <% end %>
      </div>
      <% if @place.phone_number %>
        <div class="public-profile-phone-number">
          <i class="fas fa-phone-alt"></i>
          <%= @place.phone_number %>
        </div>
      <% end %>
      <% if @place.website %>
        <div class="public-profile-website">
          <%= link_to @place.website do %>
            <i class="fas fa-globe"></i>
            <%= @place.website.sub(/https\:\/\//,'').sub(/(www.)/,'').sub(/\/$/,'') %>
          <% end %>
        </div>
      <% end %>
      <% if @place.instagram %>
        <div class="public-profile-instagram">
        <%= link_to @place.instagram do %>
          <i class="fab fa-instagram"></i>
          <%= @place.instagram.sub(/https\:\/\//,'').sub(/www.instagram.com\//,'').sub(/\/$/,'') %>
        <% end %>
      </div>
      <% end %>
    </div>
  </div>

  <!-- MAIN FIGURES PROFILE -->

  <div class="public-profile-main-figures" style="background-image: url(<%= cl_image_path("https://res.cloudinary.com/eugeniedenis/image/upload/v1593193954/wave.svg") %>)">
    <div class="public-profile-main-figures-text">
      <div class="public-profile-main-figure public-profile-number-of-ws">
        <span id="number"><%= @place.workshops.where(status: "en ligne").count %></span>
        <% if @place.workshops.where(status: "en ligne").count > 1 %>
          <span id="text">ateliers proposés</span>
        <% else %>
          <span id="text">atelier proposé</span>
        <% end %>
      </div>
      <div class="public-profile-main-figure public-profile-participants-nb">
        <% participants_number = 0 %>
        <% @place.workshops.each do |workshop| %>
          <% workshop.sessions.each do |session| %>
            <% session.bookings.each do |booking| %>
              <% participants_number += booking.quantity %>
            <% end %>
          <% end %>
        <% end %>
        <span id="number"><%= participants_number %></span>
        <% if participants_number > 1 %>
            <span id="text">participants accueillis</span>
          <% else %>
            <span id="text">participant accueilli</span>
          <% end %>
      </div>
      <div class="public-profile-main-figure public-profile-member-since">
        <span id="icon"><i class="fas fa-user-clock"></i></span>
        <span id="text">membre depuis <%= @place.created_at.year %></span>
      </div>
    </div>
  </div>

  <!-- ABOUT / WS CARDS / REVIEWS -->

  <div class="public-profile-about-ws-reviews">
    <div class="public-profile-about about-ws-reviews-box">
      <h2 class="public-profile-about-title profile-title">À propos</h2>
      <div class="public-profile-about-text">
        <p><%= @place.description %></p>
      </div>
    </div>

    <div class="public-profile-our-ws about-ws-reviews-box">
      <h2 class="public-profile-our-ws-title profile-title">Nos ateliers</h2>
      <% if @place.workshops.where(status: "en ligne") %>
        <div class="public-profile-our-ws-cards">
          <% @place.workshops.where(status: "en ligne").each do |workshop| %>
            <div class="ws-card" id="place-show-ws-card">
              <%= link_to(workshop, data: { turbolinks: false }) do  %>
                <div class="ws-card-image-and-rating">
                  <div class="ws-card-tags">
                    <% if workshop.rating %>
                      <div class="ws-card-tag ws-card-rating">
                        <i class="fas fa-star"></i><span><%= workshop.rating %></span>
                      </div>
                    <% end %>
                    <% if workshop.place.ephemeral == true %>
                      <div class="ws-card-tag ws-card-ephemeral">
                        <span>éphémère</span>
                      </div>
                    <% end %>
                  </div>
                  <%= render "workshops/ws-index-carousel", workshop: workshop %>
                </div>

                <div class="ws-card-infos">
                  <div>
                    <div class="ws-card-title">
                      <% if workshop.title.size > 33 %>
                        <h2><%= workshop.title[0..31] %>...</h2>
                      <% else %>
                        <h2><%= workshop.title %></h2>
                      <% end %>
                    </div>
                    <% if workshop.animators.first %>
                      <div class="ws-card-place" id="show-place-ws-card-place">
                        <h3>Avec <%= workshop.animators.first.user.profile.company %></h3>
                      </div>
                    <% end %>
                  </div>
                  <div class="ws-card-price">
                    <%= workshop.price %> €
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p><%= @place.name %> n'a pas d'atelier en ligne.</p>
      <% end %>
    </div>

    <div class="public-profile-reviews about-ws-reviews-box">

      <h2 class="public-profile-reviews-title profile-title">Avis sur nos ateliers</h2>
      <% reviews_count = 0 %>
      <% reviews_total_rating = 0 %>
      <% @place.workshops.each do |workshop| %>
        <% if workshop.reviews.present? %>
          <% workshop.reviews.each do |review| %>
            <% reviews_count += 1 %>
            <% reviews_total_rating += review.rating %>
          <% end %>
        <% end %>
      <% end %>
      <% reviews_average_rating = reviews_total_rating.fdiv(reviews_count).round(2) %>

      <% if reviews_count > 0 %>
        <p class="public-profile-reviews-subtitle">Note moyenne : <strong><%= reviews_average_rating %>/5</strong> (<%= reviews_count %> avis)</p>
        <div class= "reviews-cards">
          <% @place.workshops.each do |workshop| %>
            <% if workshop.reviews.present? %>
              <% workshop.reviews.each do |review| %>
                <div class="review-card">
                  <div class="review-card-stars">
                    <% review.rating.times do %>
                      <i class="fas fa-star"></i>
                    <% end %>
                    <% (5 - review.rating).times do %>
                      <i class="far fa-star"></i>
                    <% end %>
                  </div>
                  <div class="review-card-message">
                    <p><%= review.content %></p>
                  </div>
                  <div class="review-card-author">
                    <p><span><%= review.user.profile.first_name %></span>, le <%= review.created_at.strftime("%d/%m/%Y") %></p>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <p><%= @place.name %> n'a pas encore d'avis.</p>
      <% end %>

    </div>
  </div>

</div>

<p><br><br></p>
<p>----------------------------------------------</p>
<p>Ephémère : <%= @place.ephemeral %></p>
<% if current_user && policy(@place).update? %>
  <%= link_to 'Mettre à jour', edit_place_path(@place) %>
<% end %>
